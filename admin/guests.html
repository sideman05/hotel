<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guest Management - Luxury Haven Hotel Admin</title>
    <!-- Bootstrap 4 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- AdminLTE -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
    <!-- Google Font: Source Sans Pro -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    
   <link rel="stylesheet" href="/admin/styles/guests.css">
</head>
<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">

    <!-- Navbar -->
 <!-- Navbar -->
    <nav class="main-header navbar navbar-expand navbar-white navbar-light">
        <!-- Left navbar links -->
        <ul class="navbar-nav">
            <li class="nav-item">
                <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
            </li>
            <li class="nav-item d-none d-sm-inline-block">
                <a href="dashboard.html" class="nav-link">Home</a>
            </li>
            <li class="nav-item d-none d-sm-inline-block">
                <a href="../index.html" class="nav-link">View Website</a>
            </li>
        </ul>

        <!-- Right navbar links -->
        <ul class="navbar-nav ml-auto">
            <!-- Notifications Dropdown Menu -->
            <li class="nav-item dropdown">
                <a class="nav-link" data-toggle="dropdown" href="#">
                    <i class="far fa-bell"></i>
                    <span class="badge badge-warning navbar-badge">15</span>
                </a>
                <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
                    <span class="dropdown-item dropdown-header">15 Notifications</span>
                    <div class="dropdown-divider"></div>
                    <a href="#" class="dropdown-item">
                        <i class="fas fa-envelope mr-2"></i> 4 new messages
                        <span class="float-right text-muted text-sm">3 mins</span>
                    </a>
                    <div class="dropdown-divider"></div>
                    <a href="#" class="dropdown-item">
                        <i class="fas fa-users mr-2"></i> 8 new bookings
                        <span class="float-right text-muted text-sm">12 hours</span>
                    </a>
                    <div class="dropdown-divider"></div>
                    <a href="#" class="dropdown-item">
                        <i class="fas fa-file mr-2"></i> 3 new reports
                        <span class="float-right text-muted text-sm">2 days</span>
                    </a>
                    <div class="dropdown-divider"></div>
                    <a href="#" class="dropdown-item dropdown-footer">See All Notifications</a>
                </div>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-widget="fullscreen" href="#" role="button">
                    <i class="fas fa-expand-arrows-alt"></i>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#">
                    <i class="fas fa-sign-out-alt"></i>
                </a>
            </li>
        </ul>
    </nav>
    <!-- /.navbar -->

    <!-- Main Sidebar Container -->
    <aside class="main-sidebar sidebar-dark-primary elevation-4">
        <!-- Brand Logo -->
        <a href="dashboard.html" class="brand-link">
            <span class="brand-text font-weight-light ml-3">Luxury Haven Admin</span>
        </a>

        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Sidebar user panel (optional) -->
            <div class="user-panel mt-3 pb-3 mb-3 d-flex">
                <div class="image">
                    <img src="gerad.jpg" class="img-circle elevation-2" alt="User Image">
                </div>
                <div class="info">
                    <a href="#" class="d-block">Admin User</a>
                </div>
            </div>

            <!-- Sidebar Menu -->
            <nav class="mt-2">
                <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
                    <li class="nav-item">
                        <a href="dashboard.html" class="nav-link">
                            <i class="nav-icon fas fa-tachometer-alt"></i>
                            <p>Dashboard</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="rooms.html" class="nav-link">
                            <i class="nav-icon fas fa-bed"></i>
                            <p>Room Management</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="bookings.html" class="nav-link">
                            <i class="nav-icon fas fa-calendar-check"></i>
                            <p>Bookings</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="guests.html" class="nav-link active">
                            <i class="nav-icon fas fa-users"></i>
                            <p>Guests</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="amenities.html" class="nav-link">
                            <i class="nav-icon fas fa-concierge-bell"></i>
                            <p>Amenities</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="gallery.html" class="nav-link">
                            <i class="nav-icon fas fa-image"></i>
                            <p>Gallery</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="testimonials.html" class="nav-link">
                            <i class="nav-icon fas fa-star"></i>
                            <p>Testimonials</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="content.html" class="nav-link">
                            <i class="nav-icon fas fa-file-alt"></i>
                            <p>Pages Content</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="settings.html" class="nav-link">
                            <i class="nav-icon fas fa-cog"></i>
                            <p>Settings</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="help.html" class="nav-link">
                            <i class="nav-icon fas fa-question-circle"></i>
                            <p>Help & Support</p>
                        </a>
                    </li>
                </ul>
            </nav>
            <!-- /.sidebar-menu -->
        </div>
        <!-- /.sidebar -->
    </aside>

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <div class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1 class="m-0">Guest Management</h1>
                    </div><!-- /.col -->
                    <div class="col-sm-6">
                        <ol class="breadcrumb float-sm-right">
                            <li class="breadcrumb-item"><a href="dashboard.html">Home</a></li>
                            <li class="breadcrumb-item active">Guest Management</li>
                        </ol>
                    </div><!-- /.col -->
                </div><!-- /.row -->
            </div><!-- /.container-fluid -->
        </div>
        <!-- /.content-header -->

        <!-- Main content -->
        <section class="content">
            <div class="container-fluid">
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Guest Management Tools</h3>
                                <div class="card-tools">
                                    <button class="btn btn-primary" data-toggle="modal" data-target="#addGuestModal">
                                        <i class="fas fa-plus"></i> Add New Guest
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3 col-sm-6">
                                        <div class="info-box">
                                            <span class="info-box-icon bg-info"><i class="fas fa-users"></i></span>
                                            <div class="info-box-content">
                                                <span class="info-box-text">Total Guests</span>
                                                <span class="info-box-number">156</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-sm-6">
                                        <div class="info-box">
                                            <span class="info-box-icon bg-success"><i class="fas fa-bed"></i></span>
                                            <div class="info-box-content">
                                                <span class="info-box-text">Currently Staying</span>
                                                <span class="info-box-number">42</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-sm-6">
                                        <div class="info-box">
                                            <span class="info-box-icon bg-warning"><i class="fas fa-calendar-check"></i></span>
                                            <div class="info-box-content">
                                                <span class="info-box-text">Upcoming Arrivals</span>
                                                <span class="info-box-number">18</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-sm-6">
                                        <div class="info-box">
                                            <span class="info-box-icon bg-primary"><i class="fas fa-crown"></i></span>
                                            <div class="info-box-content">
                                                <span class="info-box-text">VIP Guests</span>
                                                <span class="info-box-number">9</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-12">
                        <div class="card filter-box">
                            <div class="card-body">
                                <h5 class="card-title">Filter Guests</h5>
                                <form class="form-inline">
                                    <div class="form-group mr-3 mb-2">
                                        <label for="statusFilter" class="mr-2">Status:</label>
                                        <select class="form-control" id="statusFilter">
                                            <option value="">All Guests</option>
                                            <option value="staying">Currently Staying</option>
                                            <option value="upcoming">Upcoming Arrivals</option>
                                            <option value="checkedout">Checked Out</option>
                                            <option value="vip">VIP Guests</option>
                                        </select>
                                    </div>
                                    <div class="form-group mr-3 mb-2">
                                        <label for="searchGuest" class="mr-2">Search:</label>
                                        <input type="text" class="form-control" id="searchGuest" placeholder="Name, email, phone...">
                                    </div>
                                    <button type="submit" class="btn btn-primary mb-2">
                                        <i class="fas fa-filter"></i> Apply Filters
                                    </button>
                                    <button type="reset" class="btn btn-default mb-2 ml-2">
                                        <i class="fas fa-redo"></i> Reset
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">All Guests</h3>
                                <div class="card-tools">
                                    <div class="input-group input-group-sm" style="width: 200px;">
                                        <input type="text" name="table_search" class="form-control float-right" placeholder="Search guests...">
                                        <div class="input-group-append">
                                            <button type="submit" class="btn btn-default">
                                                <i class="fas fa-search"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- /.card-header -->
                            <div class="card-body table-responsive p-0">
                                <table class="table table-hover text-nowrap" id="guestsTable">
                                    <thead>
                                        <tr>
                                            <th>Guest</th>
                                            <th>Contact</th>
                                            <th>Status</th>
                                            <th>Current Stay</th>
                                            <th>Loyalty Tier</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="guestsTableBody">
                                        <!-- Dynamic guest rows will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                            <!-- /.card-body -->
                            <div class="card-footer clearfix">
                                <ul class="pagination pagination-sm m-0 float-right">
                                    <li class="page-item"><a class="page-link" href="#">&laquo;</a></li>
                                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                    <li class="page-item"><a class="page-link" href="#">2</a></li>
                                    <li class="page-item"><a class="page-link" href="#">3</a></li>
                                    <li class="page-item"><a class="page-link" href="#">&raquo;</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- /.container-fluid -->
        </section>
        <!-- /.content -->
    </div>
    <!-- /.content-wrapper -->

    <!-- Add Guest Modal -->
    <div class="modal fade" id="addGuestModal" tabindex="-1" role="dialog" aria-labelledby="addGuestModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addGuestModalLabel">Add New Guest</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="guestFirstName">First Name</label>
                                <input type="text" class="form-control" id="guestFirstName" placeholder="First name">
                            </div>
                            <div class="form-group col-md-6">
                                <label for="guestLastName">Last Name</label>
                                <input type="text" class="form-control" id="guestLastName" placeholder="Last name">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="guestEmail">Email Address</label>
                                <input type="email" class="form-control" id="guestEmail" placeholder="Email address">
                            </div>
                            <div class="form-group col-md-6">
                                <label for="guestPhone">Phone Number</label>
                                <input type="tel" class="form-control" id="guestPhone" placeholder="Phone number">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="guestCountry">Country</label>
                                <select class="form-control" id="guestCountry">
                                    <option selected>United States</option>
                                    <option>United Kingdom</option>
                                    <option>Canada</option>
                                    <option>Australia</option>
                                    <option>Germany</option>
                                    <option>Other</option>
                                </select>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="guestIdType">ID Type</label>
                                <select class="form-control" id="guestIdType">
                                    <option selected>Passport</option>
                                    <option>Driver's License</option>
                                    <option>National ID</option>
                                    <option>Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="guestIdNumber">ID Number</label>
                            <input type="text" class="form-control" id="guestIdNumber" placeholder="ID number">
                        </div>
                        <div class="form-group">
                            <label for="guestAddress">Address</label>
                            <textarea class="form-control" id="guestAddress" rows="2" placeholder="Full address"></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="guestLoyaltyTier">Loyalty Tier</label>
                                <select class="form-control" id="guestLoyaltyTier">
                                    <option selected>Standard</option>
                                    <option>Silver</option>
                                    <option>Gold</option>
                                    <option>Platinum</option>
                                </select>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="guestPreferences">Special Preferences</label>
                                <select class="form-control" id="guestPreferences" multiple>
                                    <option>Non-smoking room</option>
                                    <option>High floor</option>
                                    <option>Early check-in</option>
                                    <option>Late check-out</option>
                                    <option>Airport transfer</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="guestNotes">Additional Notes</label>
                            <textarea class="form-control" id="guestNotes" rows="2" placeholder="Any special notes or requests"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary">Add Guest</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="main-footer">
        <strong>Copyright &copy; 2023 <a href="#">Luxury Haven Hotel</a>.</strong>
        All rights reserved.
        <div class="float-right d-none d-sm-inline-block">
            <b>Version</b> 1.0.0
        </div>
    </footer>

    <!-- Control Sidebar -->
    <aside class="control-sidebar control-sidebar-dark">
        <!-- Control sidebar content goes here -->
    </aside>
    <!-- /.control-sidebar -->
</div>
<!-- ./wrapper -->

<!-- jQuery -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<!-- Bootstrap 4 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- AdminLTE App -->
<script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>

<!-- Custom scripts -->
<script>
    $(document).ready(function() {
        // Fetch and render guests
        function fetchGuests() {
            $.get('guests_crud.php', {action: 'read'}, function(data) {
                renderGuestsTable(data);
                updateGuestStats(data);
            }, 'json');
        }
        // Update guest stats (Total Guests, Currently Staying, Upcoming Arrivals, VIP Guests)
        function updateGuestStats(guests) {
            var total = guests.length;
            var staying = 0, upcoming = 0, vip = 0;
            guests.forEach(function(g) {
                var status = (g.status || '').toLowerCase();
                var loyalty = (g.loyalty_tier || '').toLowerCase();
                // Currently Staying: status contains 'stay', 'checked in', or similar
                if (status.includes('stay') || status.includes('checked in') || status === 'in') staying++;
                // Upcoming Arrivals: status contains 'upcoming', 'arrival', 'arriving', or similar
                if (status.includes('upcoming') || status.includes('arrival') || status.includes('arriving')) upcoming++;
                // VIP Guests: status or loyalty contains 'vip'
                if (status.includes('vip') || loyalty.includes('vip')) vip++;
            });
            $(".info-box-number").eq(0).text(total); // Total Guests
            $(".info-box-number").eq(1).text(staying); // Currently Staying
            $(".info-box-number").eq(2).text(upcoming); // Upcoming Arrivals
            $(".info-box-number").eq(3).text(vip); // VIP Guests
        }

        function renderGuestsTable(guests) {
            let html = '';
            if (!guests.length) {
                html = '<tr><td colspan="6" class="text-center text-muted">No guests found.</td></tr>';
            } else {
                guests.forEach(function(g) {
                    let avatar = g.avatar ? g.avatar : (g.gender === 'female' ? 'https://randomuser.me/api/portraits/women/44.jpg' : 'https://randomuser.me/api/portraits/men/32.jpg');
                    let name = `<div class='font-weight-bold'>${g.first_name || ''} ${g.last_name || ''}</div><div class='text-muted'>ID: ${g.id || ''}</div>`;
                    let contact = `<div>${g.email || ''}</div><div class='text-muted'>${g.phone || ''}</div>`;
                    // Status logic: use g.status if present, else loyalty_tier or '-'
                    let statusText = g.status ? g.status : (g.loyalty_tier ? g.loyalty_tier : '-');
                    let statusClass = 'bg-secondary';
                    if (g.status) {
                        if (g.status.toLowerCase().includes('in')) statusClass = 'bg-success';
                        else if (g.status.toLowerCase().includes('arriv')) statusClass = 'bg-info';
                        else if (g.status.toLowerCase().includes('out')) statusClass = 'bg-secondary';
                        else if (g.status.toLowerCase().includes('vip')) statusClass = 'bg-primary';
                        else if (g.status.toLowerCase().includes('gold')) statusClass = 'bg-warning';
                        else if (g.status.toLowerCase().includes('platinum')) statusClass = 'bg-danger';
                    }
                    let status = `<span class='badge guest-status-badge ${statusClass}'>${statusText}</span>`;
                    let stay = `<div>${g.current_stay || '-'}</div><div class='text-muted'>${g.stay_dates || ''}</div>`;
                    let loyalty = `<span class='badge bg-warning'>${g.loyalty_tier || 'Standard'}</span>`;
                    html += `
                        <tr data-id="${g.id}">
                            <td><div class='d-flex align-items-center'><img src='${avatar}' class='guest-avatar mr-3' alt='User Image'><div>${name}</div></div></td>
                            <td>${contact}</td>
                            <td>${status}</td>
                            <td>${stay}</td>
                            <td>${loyalty}</td>
                            <td>
                                <button class='btn btn-sm btn-info view-guest'><i class='fas fa-eye'></i> View</button>
                                <button class='btn btn-sm btn-primary edit-guest'><i class='fas fa-edit'></i> Edit</button>
                                <button class='btn btn-sm btn-warning toggle-vip'><i class='fas fa-crown'></i> ${g.loyalty_tier && g.loyalty_tier.toLowerCase() === 'vip' ? 'Remove VIP' : 'Make VIP'}</button>
                                <button class='btn btn-sm btn-secondary toggle-status'><i class='fas fa-exchange-alt'></i> Switch Stay/Arrival</button>
                                <button class='btn btn-sm btn-danger delete-guest'><i class='fas fa-trash'></i> Delete</button>
                            </td>
                        </tr>
                    `;
        // Toggle VIP status
        $(document).on('click', '.toggle-vip', function() {
            var row = $(this).closest('tr');
            var id = row.data('id');
            if (!id) return;
            var btn = $(this);
            var makeVip = btn.text().toLowerCase().includes('make');
            $.post('guests_crud.php', {action: 'toggle_vip', id: id, vip: makeVip ? 1 : 0}, function(resp) {
                if (resp.success) {
                    fetchGuests();
                } else {
                    alert('Failed to update VIP status.');
                }
            }, 'json').fail(function() {
                alert('Failed to update VIP status.');
            });
        });

        // Toggle between Currently Staying and Upcoming Arrival
        $(document).on('click', '.toggle-status', function() {
            var row = $(this).closest('tr');
            var id = row.data('id');
            if (!id) return;
            var currentStatus = row.find('td').eq(2).text().toLowerCase();
            var newStatus = currentStatus.includes('stay') ? 'upcoming arrival' : 'currently staying';
            $.post('guests_crud.php', {action: 'toggle_status', id: id, status: newStatus}, function(resp) {
                if (resp.success) {
                    fetchGuests();
                } else {
                    alert('Failed to update status.');
                }
            }, 'json').fail(function() {
                alert('Failed to update status.');
            });
        });
                });
            }
            $('#guestsTableBody').html(html);
        }
        // Delete Guest
        $(document).on('click', '.delete-guest', function() {
            var row = $(this).closest('tr');
            var id = row.data('id');
            if (!id) return;
            if (!confirm('Delete this guest?')) return;
            $.post('guests_crud.php', {action: 'delete', id: id}, function(resp) {
                if (resp.success) {
                    row.remove();
                } else {
                    alert('Failed to delete guest.');
                }
            }, 'json').fail(function() {
                alert('Failed to delete guest.');
            });
        });

        // Edit Guest (show modal with current data)
        $(document).on('click', '.edit-guest', function() {
            var row = $(this).closest('tr');
            var id = row.data('id');
            if (!id) return;
            // Fetch guest data from backend for full info
            $.get('guests_crud.php', {action: 'read_one', id: id}, function(resp) {
                if (!resp || !resp.success || !resp.guest) {
                    alert('Failed to load guest data.');
                    return;
                }
                var g = resp.guest;
                // Fill modal fields
                $('#editGuestId').val(g.id);
                $('#editGuestFirstName').val(g.first_name);
                $('#editGuestLastName').val(g.last_name);
                $('#editGuestEmail').val(g.email);
                $('#editGuestPhone').val(g.phone);
                $('#editGuestCountry').val(g.country);
                $('#editGuestIdType').val(g.id_type);
                $('#editGuestIdNumber').val(g.id_number);
                $('#editGuestAddress').val(g.address);
                $('#editGuestLoyaltyTier').val(g.loyalty_tier);
                $('#editGuestCurrentStay').val(g.current_stay);
                $('#editGuestStatus').val(g.status);
                $('#editGuestNotes').val(g.notes);
                // Preferences (multi)
                if (g.preferences) {
                    $('#editGuestPreferences').val(g.preferences.split(','));
                } else {
                    $('#editGuestPreferences').val([]);
                }
                $('#editGuestModal').modal('show');
            }, 'json');
        });

        // Submit Edit Guest
        $('#editGuestModal .btn-primary').off('click').on('click', function(e) {
            e.preventDefault();
            $('#editGuestModal form').trigger('submit');
        });
        $('#editGuestModal form').off('submit').on('submit', function(e) {
            e.preventDefault();
            var form = $(this);
            var btn = $('#editGuestModal .btn-primary');
            btn.prop('disabled', true).text('Saving...');
            var data = {
                action: 'update',
                id: $('#editGuestId').val(),
                first_name: $('#editGuestFirstName').val(),
                last_name: $('#editGuestLastName').val(),
                email: $('#editGuestEmail').val(),
                phone: $('#editGuestPhone').val(),
                country: $('#editGuestCountry').val(),
                id_type: $('#editGuestIdType').val(),
                id_number: $('#editGuestIdNumber').val(),
                address: $('#editGuestAddress').val(),
                loyalty_tier: $('#editGuestLoyaltyTier').val(),
                current_stay: $('#editGuestCurrentStay').val(),
                status: $('#editGuestStatus').val(),
                preferences: ($('#editGuestPreferences').val() || []).join(','),
                notes: $('#editGuestNotes').val()
            };
            $.post('guests_crud.php', data, function(resp) {
                btn.prop('disabled', false).text('Save Changes');
                if (resp.success) {
                    $('#editGuestModal').modal('hide');
                    form[0].reset();
                    fetchGuests();
                } else {
                    alert('Failed to update guest.');
                }
            }, 'json').fail(function() {
                btn.prop('disabled', false).text('Save Changes');
                alert('Failed to update guest.');
            });
        });
        // Add Guest (robust: always submit form via button, only one handler)
        $('#addGuestModal .btn-primary').off('click').on('click', function(e) {
            e.preventDefault();
            $('#addGuestModal form').trigger('submit');
        });
        $('#addGuestModal form').off('submit').on('submit', function(e) {
            e.preventDefault();
            var form = $(this);
            var btn = $('#addGuestModal .btn-primary');
            btn.prop('disabled', true).text('Adding...');
            var data = {
                action: 'create',
                first_name: $('#guestFirstName').val(),
                last_name: $('#guestLastName').val(),
                email: $('#guestEmail').val(),
                phone: $('#guestPhone').val(),
                country: $('#guestCountry').val(),
                id_type: $('#guestIdType').val(),
                id_number: $('#guestIdNumber').val(),
                address: $('#guestAddress').val(),
                loyalty_tier: $('#guestLoyaltyTier').val(),
                preferences: ($('#guestPreferences').val() || []).join(','),
                notes: $('#guestNotes').val()
            };
            // Simple validation
            if (!data.first_name || !data.last_name || !data.email) {
                alert('First name, last name, and email are required.');
                btn.prop('disabled', false).text('Add Guest');
                return;
            }
            $.post('guests_crud.php', data, function(resp) {
                btn.prop('disabled', false).text('Add Guest');
                if (resp.success) {
                    $('#addGuestModal').modal('hide');
                    form[0].reset();
                    fetchGuests();
                } else {
                    alert('Failed to add guest.');
                }
            }, 'json').fail(function() {
                btn.prop('disabled', false).text('Add Guest');
                alert('Failed to add guest.');
            });
        });

        // Filter functionality (placeholder)
        $('#statusFilter, #searchGuest').on('change keyup', function() {
            // In a real application, this would filter the guest list
            // For now, just refetch all
            fetchGuests();
        });

        // Initial fetch after all handlers
        fetchGuests();
    });
</script>
<!-- Edit Guest Modal (moved after script) -->
<div class="modal fade" id="editGuestModal" tabindex="-1" role="dialog" aria-labelledby="editGuestModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editGuestModalLabel">Edit Guest</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <input type="hidden" id="editGuestId">
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="editGuestFirstName">First Name</label>
                            <input type="text" class="form-control" id="editGuestFirstName" placeholder="First name">
                        </div>
                        <div class="form-group col-md-6">
                            <label for="editGuestLastName">Last Name</label>
                            <input type="text" class="form-control" id="editGuestLastName" placeholder="Last name">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="editGuestEmail">Email Address</label>
                            <input type="email" class="form-control" id="editGuestEmail" placeholder="Email address">
                        </div>
                        <div class="form-group col-md-6">
                            <label for="editGuestPhone">Phone Number</label>
                            <input type="tel" class="form-control" id="editGuestPhone" placeholder="Phone number">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="editGuestCountry">Country</label>
                            <select class="form-control" id="editGuestCountry">
                                <option>United States</option>
                                <option>United Kingdom</option>
                                <option>Canada</option>
                                <option>Australia</option>
                                <option>Germany</option>
                                <option>Other</option>
                            </select>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="editGuestIdType">ID Type</label>
                            <select class="form-control" id="editGuestIdType">
                                <option>Passport</option>
                                <option>Driver's License</option>
                                <option>National ID</option>
                                <option>Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editGuestIdNumber">ID Number</label>
                        <input type="text" class="form-control" id="editGuestIdNumber" placeholder="ID number">
                    </div>
                    <div class="form-group">
                        <label for="editGuestAddress">Address</label>
                        <textarea class="form-control" id="editGuestAddress" rows="2" placeholder="Full address"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="editGuestLoyaltyTier">Loyalty Tier</label>
                            <select class="form-control" id="editGuestLoyaltyTier">
                                <option>Standard</option>
                                <option>Silver</option>
                                <option>Gold</option>
                                <option>Platinum</option>
                            </select>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="editGuestPreferences">Special Preferences</label>
                            <select class="form-control" id="editGuestPreferences" multiple>
                                <option>Non-smoking room</option>
                                <option>High floor</option>
                                <option>Early check-in</option>
                                <option>Late check-out</option>
                                <option>Airport transfer</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="editGuestCurrentStay">Current Stay</label>
                            <input type="text" class="form-control" id="editGuestCurrentStay" placeholder="Room or stay info">
                        </div>
                        <div class="form-group col-md-6">
                            <label for="editGuestStatus">Status</label>
                            <input type="text" class="form-control" id="editGuestStatus" placeholder="Status (e.g. staying, checked out, VIP)">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editGuestNotes">Additional Notes</label>
                        <textarea class="form-control" id="editGuestNotes" rows="2" placeholder="Any special notes or requests"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary">Save Changes</button>
            </div>
        </div>
    </div>
</div>
</body>
</html>